#!/bin/bash
# =============================================================================
# ãƒ­ãƒ¼ã‚«ãƒ«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºé©ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# =============================================================================
# forkå…ƒã¨åŒæœŸã—ãŸå¾Œã€ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«å›ºæœ‰ã®å¤‰æ›´ã‚’å†é©ç”¨
# =============================================================================

set -e

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ¯ ãƒ­ãƒ¼ã‚«ãƒ«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºé©ç”¨"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# -----------------------------------------------------------------------------
# 1. config/settings.yaml ã«ä¸Šæ›¸ãè¨­å®šã‚’ãƒãƒ¼ã‚¸
# -----------------------------------------------------------------------------
echo "ğŸ“ [1/4] config/settings.yaml ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚’ãƒãƒ¼ã‚¸ä¸­..."

if [ -f "$SCRIPT_DIR/settings_override.yaml" ]; then
    # Python ã§ YAML ã‚’ãƒãƒ¼ã‚¸ï¼ˆpython3-yaml ãŒå¿…è¦ï¼‰
    if command -v python3 >/dev/null 2>&1 && python3 -c "import yaml" 2>/dev/null; then
        python3 << 'PYTHON_EOF'
import yaml
import sys

# ãƒ™ãƒ¼ã‚¹è¨­å®šã‚’èª­ã¿è¾¼ã¿
with open("config/settings.yaml", "r") as f:
    base = yaml.safe_load(f)

# ä¸Šæ›¸ãè¨­å®šã‚’èª­ã¿è¾¼ã¿
with open("local_customizations/settings_override.yaml", "r") as f:
    override = yaml.safe_load(f)

# ãƒãƒ¼ã‚¸
base.update(override)

# æ›¸ãå‡ºã—
with open("config/settings.yaml", "w") as f:
    yaml.dump(base, f, default_flow_style=False, allow_unicode=True, sort_keys=False)

print("âœ… config/settings.yaml ã‚’æ›´æ–°ã—ã¾ã—ãŸ")
PYTHON_EOF
    else
        # Python ãŒä½¿ãˆãªã„å ´åˆã¯ã€yq ã‚„æ‰‹å‹•ã§ã®è¿½è¨˜ã‚’æ¡ˆå†…
        echo "âš ï¸  Python3 + PyYAML ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        echo "   æ‰‹å‹•ã§ä»¥ä¸‹ã‚’ config/settings.yaml ã«è¿½è¨˜ã—ã¦ãã ã•ã„:"
        cat "$SCRIPT_DIR/settings_override.yaml"
    fi
else
    echo "âš ï¸  settings_override.yaml ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
fi

echo ""

# -----------------------------------------------------------------------------
# 2. Git ãƒ•ãƒƒã‚¯ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# -----------------------------------------------------------------------------
echo "ğŸª [2/4] Gitãƒ•ãƒƒã‚¯ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."

if [ -d "$SCRIPT_DIR/hooks" ]; then
    for hook in "$SCRIPT_DIR/hooks"/*; do
        if [ -f "$hook" ]; then
            hook_name=$(basename "$hook")
            cp "$hook" "$REPO_ROOT/.git/hooks/$hook_name"
            chmod +x "$REPO_ROOT/.git/hooks/$hook_name"
            echo "   âœ… $hook_name ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸ"
        fi
    done
else
    echo "âš ï¸  hooks/ ãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
fi

echo ""

# -----------------------------------------------------------------------------
# 3. Makefile ã‚’æ‹¡å¼µ
# -----------------------------------------------------------------------------
echo "ğŸ”§ [3/4] Makefile ã‚’æ‹¡å¼µä¸­..."

if [ -f "$SCRIPT_DIR/makefile_extensions.mk" ]; then
    # æ—¢å­˜ã®Makefileã«è¿½åŠ ã‚³ãƒãƒ³ãƒ‰ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if ! grep -q "# ãƒ­ãƒ¼ã‚«ãƒ«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º" "$REPO_ROOT/Makefile" 2>/dev/null; then
        # Makefileã®æœ«å°¾ã«è¿½è¨˜
        cat >> "$REPO_ROOT/Makefile" << 'MAKEFILE_APPEND'

# =============================================================================
# ãƒ­ãƒ¼ã‚«ãƒ«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼ˆlocal_customizations/ ã‹ã‚‰è‡ªå‹•è¿½åŠ ï¼‰
# =============================================================================
MAKEFILE_APPEND
        cat "$SCRIPT_DIR/makefile_extensions.mk" >> "$REPO_ROOT/Makefile"
        echo "   âœ… Makefile ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚³ãƒãƒ³ãƒ‰ã‚’è¿½åŠ ã—ã¾ã—ãŸ"
    else
        echo "   â„¹ï¸  Makefile ã«ã¯æ—¢ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒå«ã¾ã‚Œã¦ã„ã¾ã™"
    fi
else
    echo "âš ï¸  makefile_extensions.mk ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
fi

echo ""

# -----------------------------------------------------------------------------
# 4. shutsujin_departure.sh ã« ashigaru_count å¯¾å¿œã‚’è¿½åŠ ï¼ˆå¿…è¦ãªå ´åˆï¼‰
# -----------------------------------------------------------------------------
echo "âš™ï¸  [4/4] shutsujin_departure.sh ã® ashigaru_count å¯¾å¿œã‚’ç¢ºèªä¸­..."

if ! grep -q "ashigaru_count" "$REPO_ROOT/shutsujin_departure.sh" 2>/dev/null; then
    echo "âš ï¸  shutsujin_departure.sh ã¯ ashigaru_count ã«æœªå¯¾å¿œã§ã™"
    echo "   æ‰‹å‹•ã§å¯¾å¿œãŒå¿…è¦ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆå¯¾å¿œæ–¹æ³•ã¯å¾Œè¿°ï¼‰"
else
    echo "   âœ… shutsujin_departure.sh ã¯æ—¢ã« ashigaru_count ã«å¯¾å¿œã—ã¦ã„ã¾ã™"
fi

echo ""

# -----------------------------------------------------------------------------
# å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
# -----------------------------------------------------------------------------
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã®é©ç”¨ãŒå®Œäº†ã—ã¾ã—ãŸ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“‹ é©ç”¨ã•ã‚ŒãŸå†…å®¹:"
echo "   1. config/settings.yaml: ashigaru_count ãªã©ã®ä¸Šæ›¸ã"
echo "   2. .git/hooks/: git push ç¦æ­¢ãƒ•ãƒƒã‚¯"
echo "   3. Makefile: æ“ä½œã‚³ãƒãƒ³ãƒ‰ã®è¿½åŠ "
echo ""
echo "ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
echo "   make status    # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª"
echo "   make shutsujin # å‡ºé™£ï¼ˆå…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèµ·å‹•ï¼‰"
echo ""
